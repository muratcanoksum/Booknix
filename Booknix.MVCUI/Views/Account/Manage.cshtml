@{
    ViewData["Title"] = "Hesabım";
}

<div class="max-w-4xl mb-[150px] mx-auto mt-20 bg-white shadow rounded-lg flex p-5">
    <!-- Sol Menü -->
    <div class="w-1/4 border-r">
        <ul class="space-y-2 p-4 text-sm">
            <li>
                <a href="#" class="menu-link block py-2 px-3 hover:bg-gray-100 font-medium text-gray-700" data-url="/Account/Profile">
                    <i class="fas fa-user mr-2"></i> Profil Bilgileri
                </a>
            </li>
            <li>
                <a href="#" class="menu-link block py-2 px-3 hover:bg-gray-100 font-medium text-gray-700" data-url="/Account/ProfilePhoto">
                    <i class="fas fa-camera mr-2"></i> Profil Fotoğrafı
                </a>
            </li>
            <li>
                <a href="#" class="menu-link block py-2 px-3 hover:bg-gray-100 font-medium text-gray-700" data-url="/Account/ChangePassword">
                    <i class="fas fa-key mr-2"></i> Şifre Değiştir
                </a>
            </li>
            <li>
                <a href="#" class="menu-link block py-2 px-3 hover:bg-gray-100 font-medium text-gray-700" data-url="/Account/ChangeEmail">
                    <i class="fas fa-envelope mr-2"></i> E-Posta Değiştir
                </a>
            </li>
            <li>
                <a href="#" class="menu-link block py-2 px-3 hover:bg-red-50 text-red-600 font-semibold" data-url="/Account/Delete">
                    <i class="fas fa-trash-alt mr-2"></i> Hesabı Sil
                </a>
            </li>
        </ul>
    </div>


    <!-- Sağ İçerik -->
    <div id="content-panel" class="w-3/4 p-6">
        <div class="text-sm text-gray-500">Yükleniyor...</div>
    </div>
</div>

@section Scripts {

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cleave.js@1/dist/cleave.min.js"></script>

    <script>
        function initCleavePhoneMask() {
            const $input = $('#phone-input');
            if ($input.length && !$input.data('cleave-applied')) {
                new Cleave('#phone-input', {
                    delimiters: ['(', ') ', ' ', ' '],
                    blocks: [0, 3, 3, 2, 2],
                    numericOnly: true
                });

                // Tekrar tetiklenmemesi için işaret bırak
                $input.data('cleave-applied', true);
            }
        }

        function setTimeoutAlert(id_name) {
            setTimeout(() => {
                const $success = $(id_name);
                if ($success.length) {
                    $success.fadeOut("slow", function () {
                        $(this).remove();
                    });
                }
            }, 4000);
        }


        // Menü tıklama olayını dinle
        $(function () {
            $(".menu-link").on("click", function (e) {
                e.preventDefault();
                const $link = $(this);
                const url = $link.data("url");

                // Aktif sınıfı tüm menülerden kaldır
                $(".menu-link").removeClass("bg-blue-100 text-blue-700 font-semibold");

                // Tıklanan menüye aktif sınıfı ekle
                $link.addClass("bg-blue-100 text-blue-700 font-semibold");

                // İçeriği yükle
                $("#content-panel").html("Yükleniyor...");
                $.get(url, function (html) {
                    $("#content-panel").html(html);
                    initCleavePhoneMask();
                }).fail(function () {
                    $("#content-panel").html(`
                   <div class="flex flex-col items-center justify-center text-center space-y-4">
                    <img src="/images/logo.png" alt="Booknix Logo" class="w-24 h-24">
                    <h2 class="text-xl font-bold text-gray-700">404 - İçerik Bulunamadı</h2>
                    <p class="text-sm text-gray-500">İstediğiniz içerik yüklenemedi veya bulunamadı.</p
                        </div>
`);
                });
            });

            // Sayfa ilk açıldığında ilk menü seçili olsun
            $(".menu-link").first().trigger("click");
        });

        // Profil bilgilerini güncelleme
        $(document).on("submit", "#profile-form", function (e) {
            e.preventDefault();

            const $form = $(this);
            const $btn = $form.find("button[type='submit']");
            const $alert = $("#profile-alert");
            const token = $form.find('input[name="__RequestVerificationToken"]').val();

            $btn.prop("disabled", true).text("Kaydediliyor...");
            $.ajax({
                type: "POST",
                url: "/Account/Profile",
                data: $form.serialize(),
                headers: {
                    "RequestVerificationToken": token
                },
                success: function (msg) {
                    $alert
                        .removeClass("hidden text-red-500 bg-red-100 border-red-300")
                        .addClass("text-green-600 bg-green-100 border border-green-300")
                        .text(msg);
                    setTimeoutAlert("#profile-alert");
                },
                error: function (xhr) {
                    console.log(xhr);
                    const msg = xhr.responseText || "Bir hata oluştu.";
                    $alert
                        .removeClass("hidden text-green-600 bg-green-100 border-green-300")
                        .addClass("text-red-500 bg-red-100 border border-red-300")
                        .text(msg);
                },
                complete: function () {
                    $btn.prop("disabled", false).text("Güncelle");
                }
            });
        });

        // Profil fotoğrafını güncelleme işlemi
        $(document).on("submit", "#profile-photo-form", function (e) {
            e.preventDefault();

            const $form = $(this);
            const $btn = $form.find("button[type='submit']");
            const $alert = $("#profile-photo-alert");
            const token = $form.find('input[name="__RequestVerificationToken"]').val();

            $btn.prop("disabled", true).text("Yükleniyor...");

            var formData = new FormData($form[0]); // FormData ile dosya yükleme

            $.ajax({
                type: "POST",
                url: "/Account/ProfilePhoto",
                data: formData,
                contentType: false,
                processData: false,
                headers: {
                    "RequestVerificationToken": token
                },
                success: function (msg) {
                    $alert
                        .removeClass("hidden text-red-500 bg-red-100 border-red-300")
                        .addClass("text-green-600 bg-green-100 border border-green-300")
                        .text("Profil fotoğrafınız başarıyla güncellendi.");

                    setTimeoutAlert("#profile-photo-alert");

                    // Profil fotoğrafını hemen güncelle
                    if (msg) {
                        $("img[alt='Profil Fotoğrafı']").attr("src", msg);
                    }
                },
                error: function (xhr) {
                    const msg = xhr.responseText || "Bir hata oluştu.";
                    $alert
                        .removeClass("hidden text-green-600 bg-green-100 border-green-300")
                        .addClass("text-red-500 bg-red-100 border border-red-300")
                        .text(msg);
                },
                complete: function () {
                    $btn.prop("disabled", false).text("Güncelle");
                }
            });
        });

        //Hesap şifresi değiştirme
        $(document).on("submit", "#reset-password-form", function (e) {
            e.preventDefault();

            const $form = $(this);
            const $btn = $form.find("button[type='submit']");
            const $alert = $("#reset-password-alert");
            const token = $form.find('input[name="__RequestVerificationToken"]').val();

            console.log($form)

            $btn.prop("disabled", true).text("Kaydediliyor...");

            $.ajax({
                type: "POST",
                url: "/Account/ChangePassword",  // POST işlemi yapılacak URL
                data: $form.serialize(),
                headers: {
                    "RequestVerificationToken": token
                },
                success: function (msg) {
                    $alert
                        .removeClass("hidden text-red-500 bg-red-100 border-red-300")
                        .addClass("text-green-600 bg-green-100 border border-green-300")
                        .text(msg);
                    setTimeoutAlert("#reset-password-alert");
                },
                error: function (xhr) {
                    const msg = xhr.responseText || "Bir hata oluştu.";
                    $alert
                        .removeClass("hidden text-green-600 bg-green-100 border-green-300")
                        .addClass("text-red-500 bg-red-100 border border-red-300")
                        .text(msg);
                },
                complete: function () {
                    $btn.prop("disabled", false).text("Şifreyi Güncelle");
                }
            });
        });


    </script>

}


